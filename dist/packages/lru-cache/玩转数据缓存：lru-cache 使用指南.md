---
title: "ç©è½¬æ•°æ®ç¼“å­˜ï¼šlru-cache ä½¿ç”¨æŒ‡å—"
tags: ["Node.js", "ç¼“å­˜", "lru-cache", "å‰ç«¯å¼€å‘"]
desc: "æ·±å…¥è§£æå’Œä½¿ç”¨ Node.js ä¸­é«˜æ€§èƒ½çš„ LRU ç¼“å­˜åº“ lru-cacheï¼Œæå‡ä½ çš„åº”ç”¨æ€§èƒ½ã€‚"
pkgName: "lru-cache"
---

# ç©è½¬æ•°æ®ç¼“å­˜ï¼šlru-cache ä½¿ç”¨æŒ‡å—

åœ¨ç°ä»£åº”ç”¨å¼€å‘ä¸­ï¼Œç¼“å­˜æœºåˆ¶æ˜¯æå‡æ€§èƒ½çš„å…³é”®æŠ€æœ¯ä¹‹ä¸€ã€‚lru-cache æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ç¼“å­˜åº“ï¼Œå®ƒåˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡¹ç›®ï¼ˆLeast Recently Usedï¼ŒLRUï¼‰ã€‚å¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ç§æ–¹å¼ï¼Œä»¥ä¼˜åŒ–ä½ çš„æ•°æ®å­˜å–æ•ˆç‡ï¼Œé‚£ä¹ˆä½ æ¥å¯¹åœ°æ–¹äº†ï¼

æœ¬æ–‡å°†å…¨é¢è®²è§£ lru-cache çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¸¦ä½ ä»å®‰è£…åˆ°å®æˆ˜ä¸€è·¯ç•…æ¸¸ï¼

## ğŸ“¦ å®‰è£… lru-cache

å¼€å§‹ä¹‹å‰ï¼Œä½ éœ€è¦é€šè¿‡ npm å‘½ä»¤å°† lru-cache å®‰è£…åˆ°ä½ çš„é¡¹ç›®ä¸­ï¼š

```shell
npm install lru-cache --save
```

å®‰è£…å®Œæ¯•åï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä¸€æ–¹å¼åœ¨é¡¹ç›®ä¸­å¼•å…¥ï¼š

```javascript
// ä½¿ç”¨ ES6 æ¨¡å—å¯¼å…¥æ–¹å¼
import { LRUCache } from 'lru-cache'

// æˆ–è€…ä½¿ç”¨ CommonJS require æ–¹å¼
const { LRUCache } = require('lru-cache')

// å¦‚æœä½ åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œå¯ä»¥é€šè¿‡ minified ç‰ˆæœ¬åŠ è½½
import { LRUCache } from 'http://unpkg.com/lru-cache@9/dist/mjs/index.min.mjs'
```

## ğŸ— åŸºç¡€ç”¨æ³•

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª LRUCache å®ä¾‹å¹¶è®¾å®šæœ€å¤§å®¹é‡ï¼š

```javascript
const cache = new LRUCache({ max: 500 });

// å­˜å‚¨é”®å€¼å¯¹
cache.set('key', 'value');

// æ£€ç´¢å€¼
const value = cache.get('key');  // è¿”å› "value"
```

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨éå­—ç¬¦ä¸²é”®ã€‚åªéœ€æ³¨æ„ï¼Œè¿™å¿…é¡»æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸åªæ˜¯ç»“æ„ç›¸åŒï¼š

```javascript
var someObject = { a: 1 };
cache.set(someObject, 'some value');

// è¿™é‡Œå¿…é¡»ä¼ é€’åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨
console.log(cache.get(someObject));  // è¾“å‡º 'some value'
```

æ¸…ç©ºæ•´ä¸ªç¼“å­˜éå¸¸ç®€å•ï¼š

```javascript
cache.clear();
```

## ğŸ”„ æ›´å¤šçš„æ“ä½œ

lru-cache æä¾›äº†ä¸€ç³»åˆ—å®ç”¨çš„æ–¹æ³•æ¥ç®¡ç†ç¼“å­˜å†…å®¹ï¼š

```javascript
// æ£€æŸ¥æŸä¸ªé”®æ˜¯å¦å­˜åœ¨
const hasKey = cache.has('key');

// åˆ é™¤æŸä¸ªé”®
cache.delete('key');

// éå†ç¼“å­˜ä¸­çš„æ‰€æœ‰å€¼
for (const value of cache.values()) {
  console.log(value);
}

// è¿ç”¨ LRU åŸåˆ™å¼¹å‡ºæœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´ 
const oldValue = cache.pop();
```

## â³ ä½¿ç”¨ TTL

ä½ ä¹Ÿå¯ä»¥ç»™ç¼“å­˜å†…å®¹è®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼ˆTTLï¼‰ï¼Œè¶…æ—¶åä¼šå°†å®ƒä»¬è§†ä¸ºè¿‡æœŸï¼š

```javascript
// åˆ›å»ºå¸¦æœ‰ TTL çš„ç¼“å­˜å®ä¾‹
const cacheWithTTL = new LRUCache({ max: 100, ttl: 1000 * 60 * 2 });

cacheWithTTL.set('key', 'value');

// å³ä¾¿é¡¹ç›®è¿‡æœŸäº†ï¼Œä½ å¯ä»¥è®¾ç½® allowStale é€‰é¡¹åœ¨åˆ é™¤å‰è¿”å›æ—§çš„é¡¹ç›®
const staleValue = cacheWithTTL.get('key', { allowStale: true });
```

## ğŸ’« å¼‚æ­¥æ”¯æŒä¸å®æ—¶åˆ·æ–°

å¦‚æœä½ æƒ³è¦æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œæ¯”å¦‚åœ¨ç¼“å­˜é¡¹è¿‡æœŸååœ¨åå°å¼‚æ­¥åˆ·æ–°å®ƒä»¬ï¼Œlru-cache æä¾›äº† `fetchMethod` é€‰é¡¹æ¥å®ç°ï¼š

```javascript
const cacheWithAsync = new LRUCache({
  max: 100,
  ttl: 1000 * 60,
  fetchMethod: async (key, staleValue, { options, signal, context }) => {
    // ä½ çš„å¼‚æ­¥å–æ•°æ®é€»è¾‘ï¼Œä¾‹å¦‚ HTTP è¯·æ±‚
    const newValue = await fetchData(key);
    return newValue;
  }
});

// ä½¿ç”¨ fetch() æ–¹æ³•ä¼šåœ¨éœ€è¦æ—¶è‡ªåŠ¨å¼‚æ­¥æ›´æ–°ç¼“å­˜
const value = await cacheWithAsync.fetch('key');
```

## ğŸ“ˆ æ€§èƒ½å’Œæœ€ä½³å®è·µ

ç‰ˆæœ¬7çš„lru-cacheå·²ç»æˆä¸ºJavaScriptä¸­æœ€é«˜æ€§èƒ½çš„LRUç¼“å­˜å®ç°ä¹‹ä¸€ã€‚è®°ä½ä»¥ä¸‹æœ€ä½³å®è·µï¼Œä»¥ç¡®ä¿ä½ çš„ç¼“å­˜æœºåˆ¶æœ€é«˜æ•ˆï¼š

- **é¢„å…ˆåˆ†é…å­˜å‚¨**ï¼šå°½é‡åœ¨LRUCacheæ„é€ å‡½æ•°ä¸­è®¾ç½®`max`é€‰é¡¹ï¼Œè¿™æ ·å¯ä»¥é¢„å…ˆåˆ†é…å†…å­˜ã€‚
- **é¿å…è¿‡åº¦ä½¿ç”¨**ï¼šé™¤éç»å¯¹éœ€è¦ï¼Œä¸è¦ä½¿ç”¨`dispose`å‡½æ•°ã€å¤§å°è·Ÿè¸ªæˆ–TTLè¡Œä¸ºï¼Œå› ä¸ºè¿™äº›åŠŸèƒ½éƒ½ä¼šå½±å“æ€§èƒ½ã€‚
- **é”®å€¼ç±»å‹**ï¼šå°½é‡ä½¿ç”¨çŸ­å­—ç¬¦ä¸²æˆ–æ•´æ•°ä½œä¸ºé”®ï¼Œå®ƒä»¬é€šå¸¸ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚

é€šè¿‡ä»¥ä¸Šä»‹ç»ï¼Œä½ åº”è¯¥å·²ç»å…·å¤‡äº†ä½¿ç”¨ lru-cache çš„åŸºæœ¬èƒ½åŠ›ã€‚å°è¯•å°†å…¶åº”ç”¨åˆ°ä½ çš„é¡¹ç›®ä¸­ï¼Œè®©æ•°æ®å¤„ç†æ›´åŠ è¿…é€Ÿé«˜æ•ˆï¼

> ä»“åº“åœ°å€ï¼šhttps://github.com/isaacs/node-lru-cache