---
title: "æºæ‰‹ coï¼šå¼€å¯ Node.js ä¸­çš„ä¼˜é›…å¼‚æ­¥æµç¨‹æ§åˆ¶"
tags: ["Node.js", "å¼‚æ­¥ç¼–ç¨‹", "Promise", "Generator"]
desc: "æ·±å…¥è§£æä½¿ç”¨ co æ¨¡å—åœ¨ Node.js ä¸­è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹çš„å®è·µå’ŒåŸç†ï¼Œè®©ä½ çš„å¼‚æ­¥ä»£ç æµç•…å¦‚è¯—ã€‚"
pkgName: "co"
---

# æºæ‰‹ coï¼šå¼€å¯ Node.js ä¸­çš„ä¼˜é›…å¼‚æ­¥æµç¨‹æ§åˆ¶

co æ¨¡å—æä¾›äº†ä¸€ç§ç®€æ´ä¸”å¼ºå¤§çš„æ–¹å¼æ¥å¤„ç† Node.js ä¸­çš„å¼‚æ­¥æ“ä½œã€‚é€šè¿‡ä½¿ç”¨ Promise å’Œ Generator å‡½æ•°ï¼Œco è®©ä½ å¯ä»¥ç”¨åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥ä»£ç ï¼Œè®©æµç¨‹æ§åˆ¶ä¸å†æ˜¯ç—›ç‚¹ã€‚

## ğŸ–¥ å®‰è£… co

åœ¨å¼€å§‹ä½¿ç”¨ co ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆé€šè¿‡ NPM å°†å…¶å®‰è£…åˆ°ä½ çš„é¡¹ç›®ä¸­ï¼š

```shell
$ npm install co
```

å®‰è£…å®Œæˆåï¼Œå°±å¯ä»¥åœ¨ä½ çš„ Node.js åº”ç”¨ä¸­å¼•å…¥å¹¶ä½¿ç”¨ co äº†ã€‚

## ğŸ”— ä½¿ç”¨ co è¿›è¡Œæµç¨‹æ§åˆ¶

co çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯è‡ªåŠ¨æ‰§è¡Œ Generator å‡½æ•°ï¼Œè®©ä½ å¯ä»¥ä½¿ç”¨ `yield` å…³é”®å­—ç­‰å¾… Promise å¯¹è±¡çš„è§£å†³ã€‚

### ç®€å•çš„ä¾‹å­

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ co æ‰§è¡Œå¼‚æ­¥æ“ä½œçš„åŸºæœ¬ç¤ºä¾‹ï¼š

```javascript
const co = require('co');

co(function* () {
  let result = yield Promise.resolve(true);
  console.log(result); // è¾“å‡ºï¼štrue
}).catch(function (err) {
  console.error(err.stack);
});
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`yield` å…³é”®è¯ç”¨æ¥ç­‰å¾… Promise çš„è§£å†³ã€‚ç„¶åï¼Œco è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `.catch` æ¥å¤„ç†å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚

### å¹¶è¡Œå¤„ç†

å¦‚æœä½ æœ‰å¤šä¸ªå¼‚æ­¥æ“ä½œéœ€è¦å¹¶è¡Œæ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨æ•°ç»„çš„å½¢å¼å°†å®ƒä»¬æ”¾åœ¨ä¸€èµ·ï¼š

```javascript
co(function* () {
  let [a, b, c] = yield [
    Promise.resolve(1),
    Promise.resolve(2),
    Promise.resolve(3)
  ];
  console.log(a, b, c); // è¾“å‡ºï¼š1 2 3
}).catch(function (err) {
  console.error(err.stack);
});
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸‰ä¸ª Promise éƒ½æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œco ä¼šç­‰å¾…æ‰€æœ‰çš„ Promise å®Œæˆåç»§ç»­æ‰§è¡Œã€‚

### ä½¿ç”¨ co.wrap åŒ…è£…å‡½æ•°

å¦‚æœä½ æƒ³å°† Generator å‡½æ•°è½¬æ¢æˆè¿”å› Promise çš„æ™®é€šå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨ `co.wrap` æ–¹æ³•ï¼š

```javascript
const fn = co.wrap(function* (val) {
  return yield Promise.resolve(val);
});

fn(true).then(function (val) {
  console.log(val); // è¾“å‡ºï¼štrue
});
```

è¿™è®©å°†ç°æœ‰çš„ Generator å‡½æ•°è½¬æ¢ä¸ºè¿”å› Promise æ›´åŠ ç®€å•ï¼Œè¿™æ˜¯åœ¨å‘ `async/await` è¿‡æ¸¡çš„è¿‡ç¨‹ä¸­éå¸¸æœ‰ç”¨çš„æŠ€å·§ã€‚

> ä»“åº“åœ°å€ï¼šhttps://github.com/tj/co

## ğŸ›  é«˜çº§ä½¿ç”¨æ¡ˆä¾‹

co ä¸ä»…æ”¯æŒ Promiseï¼Œè¿˜æ”¯æŒå¤šç§ç±»å‹çš„ `yieldable` å¯¹è±¡ã€‚

### å¯¹è±¡å±æ€§å¹¶è¡Œè§£æ

ä¸æ•°ç»„ç±»ä¼¼ï¼Œä½ ä¹Ÿå¯ä»¥å¹¶è¡Œè§£æå¯¹è±¡ä¸­çš„ Promiseï¼š

```javascript
co(function* () {
  let res = yield {
    one: Promise.resolve(1),
    two: Promise.resolve(2)
  };
  console.log(res); // è¾“å‡ºï¼š{ one: 1, two: 2 }
}).catch(function (err) {
  console.error(err.stack);
});
```

è¿™æ˜¯å¤„ç†åŒæ—¶ä¾èµ–äºå¤šä¸ªå¼‚æ­¥æ•°æ®æºçš„å¯¹è±¡å±æ€§æ—¶éå¸¸æœ‰ç”¨çš„ã€‚

### é”™è¯¯å¤„ç†

co ä½¿å¾—åœ¨ Generator å‡½æ•°ä¸­ä½¿ç”¨ `try/catch` è¿›è¡Œé”™è¯¯å¤„ç†å˜å¾—éå¸¸è‡ªç„¶ï¼š

```javascript
co(function* () {
  try {
    yield Promise.reject(new Error('å‡ºé”™äº†ï¼'));
  } catch (err) {
    console.error(err.message); // è¾“å‡ºï¼š"å‡ºé”™äº†ï¼"
  }
}).catch(function (err) {
  console.error(err.stack);
});
```

è¿™ä½¿å¾—å¼‚æ­¥ä»£ç çš„é”™è¯¯å¤„ç†ä¸åŒæ­¥ä»£ç å‡ ä¹æ²¡æœ‰å·®åˆ«ã€‚

é€šè¿‡ä¸Šè¿°ç¤ºä¾‹å’Œè®²è§£ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œco æ¨¡å—è®© Node.js ä¸­çš„å¼‚æ­¥æ“ä½œç®€å•ã€ç›´è§‚å¹¶ä¸”å®¹æ˜“ç®¡ç†ã€‚éšç€ `async/await` è¯­æ³•çš„æ¨å¹¿å’Œæ ‡å‡†åŒ–ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿä½¿ç”¨æ›´åŠ è‡ªç„¶çš„è¯­è¨€ç‰¹æ€§æ¥å¤„ç†å¼‚æ­¥æµç¨‹ï¼Œco æ˜¯è¿›å…¥è¿™ä¸ªä¸–ç•Œçš„å®Œç¾è·³æ¿ã€‚